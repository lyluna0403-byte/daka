<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>静好 - 极简习惯打卡</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@phosphor-icons/web@2.1.1/src/regular/style.css">
    <!-- Chart.js for Statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            light: '#E0E7FF', // Indigo 100 (浅紫蓝，用于底色/徽章)
                            main: '#4F46E5',  // Indigo 600 (主色，强调)
                            dark: '#312E81',  // Indigo 900 (深紫蓝，用于大标题)
                            text: '#0F172A'   // Slate 900 (深邃黑蓝，用于正文)
                        }
                    },
                    fontFamily: {
                        sans: ['"PingFang SC"', '"Microsoft YaHei"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        html { font-size: 16px; }

        body {
            background-color: #F8FAFC; /* Slate 50 更干净的浅灰蓝底色 */
            color: #0F172A;
            overflow-x: hidden;
            min-height: 100dvh;
        }

        /* 动态毛玻璃背景球 - 高饱和炫彩色调 */
        .bg-shape {
            position: fixed;
            border-radius: 50%;
            filter: blur(90px); /* 增加模糊度让光晕更融合 */
            z-index: -1;
            opacity: 0.55;
            animation: float 20s infinite alternate ease-in-out;
        }
        .shape-1 { width: 450px; height: 450px; background: #3B82F6; top: -10%; left: -5%; } /* 亮蓝色 */
        .shape-2 { width: 550px; height: 550px; background: #9333EA; bottom: -10%; right: -5%; animation-delay: -5s; } /* 亮紫色 */
        .shape-3 { width: 350px; height: 350px; background: #06B6D4; top: 35%; left: 35%; animation-delay: -10s; } /* 青色 */

        @keyframes float {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(40px, 60px) scale(1.15); }
        }

        /* 高级毛玻璃面板 - 增强背景对比度 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 15px 50px -10px rgba(15, 23, 42, 0.15);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.7);
            border-radius: 1rem;
            transition: all 0.3s ease;
        }
        .glass-card:hover {
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.08);
        }

        /* 输入框与按钮特效 */
        .glass-input {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.9);
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            color: #0F172A;
        }
        .glass-input:focus {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.25);
            outline: none;
            border-color: #4F46E5;
        }
        .glass-input::placeholder {
            color: #94A3B8;
        }

        .glass-btn {
            background: linear-gradient(135deg, rgba(224, 231, 255, 0.9), rgba(199, 210, 254, 0.8));
            border: 1px solid rgba(255, 255, 255, 0.9);
            color: #312E81;
            font-weight: 500;
            backdrop-filter: blur(4px);
            transition: all 0.3s ease;
        }
        .glass-btn:hover {
            background: linear-gradient(135deg, rgba(199, 210, 254, 1), rgba(165, 180, 252, 1));
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }

        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(79, 70, 229, 0.3); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(79, 70, 229, 0.6); }

        /* 隐藏类 */
        .hidden-tab { display: none !important; }

        /* 页面内确认弹窗 */
        .modal-mask {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.35);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-mask.show {
            display: flex;
        }

        .app-shell {
            width: min(96vw, 1520px);
            height: min(94dvh, 980px);
            max-height: none;
            margin: 0 auto;
        }

        .app-sidebar {
            flex: 0 0 clamp(260px, 22vw, 330px);
            min-width: 0;
        }

        .app-main {
            min-width: 0;
            padding: clamp(1rem, 2.1vw, 2.1rem) clamp(1rem, 2.2vw, 2.5rem);
        }

        /* Mobile-only navigation defaults (hidden on desktop/tablet) */
        #mobile-drawer,
        #mobile-drawer-mask,
        #mobile-topbar {
            display: none;
        }

        @media (min-width: 1200px) {
            html { font-size: 17px; }
            .app-shell {
                width: min(95vw, 1500px);
                height: min(92dvh, 960px);
                border-radius: 2.2rem;
            }
            .app-sidebar {
                background: linear-gradient(180deg, rgba(236, 242, 255, 0.88), rgba(231, 238, 255, 0.72));
                padding: 1.5rem 1.35rem;
            }
            .app-sidebar nav button {
                font-size: 1.08rem;
            }
            .app-main {
                background: linear-gradient(180deg, rgba(255,255,255,0.26), rgba(255,255,255,0.08));
                padding-top: 1.6rem;
            }
            #view-checkin > header {
                margin-bottom: 0.75rem;
            }
            #view-checkin,
            #view-stats,
            #view-records {
                width: 100%;
                max-width: none;
                margin-left: auto;
                margin-right: auto;
            }
            #empty-state {
                height: 22rem;
            }
            #weekly-calendar {
                margin-bottom: 0.8rem !important;
                padding-top: 0.6rem;
                padding-bottom: 0.6rem;
            }
            #new-habit-input { font-size: 1.02rem; }
            #add-habit-form button { font-size: 1rem; }
            #checkin-date-tip { font-size: 0.95rem; }
            #habits-list { gap: 0.75rem !important; }
            #habits-list .glass-card { padding: 0.9rem !important; }
            #habits-list .habit-title {
                font-size: 1.18rem !important;
                line-height: 1.3 !important;
            }
            #habits-list .habit-note {
                min-height: 40px !important;
                font-size: 0.85rem !important;
                padding-top: 0.52rem !important;
                padding-bottom: 0.52rem !important;
            }
            #habits-list .habit-action {
                padding-top: 0.4rem !important;
                padding-bottom: 0.4rem !important;
                padding-left: 0.85rem !important;
                padding-right: 0.85rem !important;
                font-size: 0.94rem !important;
            }
        }

        @media (max-width: 1024px) {
            .app-shell {
                width: 100%;
                height: auto;
                min-height: calc(100dvh - 1rem);
                border-radius: 1.35rem;
            }
            .app-main {
                padding: 1rem;
            }
        }

        @media (max-width: 768px) {
            html {
                font-size: 15px;
            }
            .app-shell {
                min-height: calc(100dvh - 0.75rem);
                border-radius: 1.25rem;
            }
            .app-main {
                padding: 1rem;
                padding-top: 1rem;
            }
            #mobile-menu-toggle {
                display: flex !important;
                position: static !important;
                top: auto !important;
                left: auto !important;
            }
            #mobile-drawer {
                display: flex !important;
                left: 0;
                top: 0.35rem;
                bottom: 0.35rem;
                height: auto;
                border-radius: 0 1rem 1rem 0;
                overflow: hidden;
                border-right: none;
                box-shadow: 8px 0 20px rgba(15, 23, 42, 0.12);
            }
            #mobile-drawer:not(.nav-expanded) #mobile-drawer-close {
                display: none !important;
            }
            #mobile-drawer.nav-expanded #mobile-drawer-close {
                display: flex !important;
            }
            #mobile-topbar {
                display: flex !important;
            }
            #mobile-drawer nav {
                width: 100%;
            }
            #mobile-drawer nav button {
                width: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.65rem;
                padding: 0.72rem 0.5rem;
                border-radius: 0.75rem;
                overflow: hidden;
            }
            #mobile-drawer nav button i {
                width: 1.35rem;
                min-width: 1.35rem;
                text-align: center;
            }
            #mobile-drawer.nav-expanded nav button {
                justify-content: flex-start;
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
            #mobile-drawer.nav-expanded .mobile-label {
                display: inline;
            }
            #mobile-drawer:not(.nav-expanded) .mobile-label {
                display: none !important;
            }
            #mobile-drawer .mobile-active {
                background: rgba(224, 231, 255, 0.78);
                color: #4F46E5 !important;
                font-weight: 600;
            }
        }

        @media (max-height: 620px) and (orientation: landscape) {
            html {
                font-size: 14px;
            }
            body {
                padding: 0.25rem;
            }
            .app-shell {
                min-height: calc(100vh - 0.5rem);
                border-radius: 0.75rem;
            }
            .app-sidebar {
                padding: 0.75rem 1rem;
            }
            .app-main {
                padding: 0.75rem 1rem;
            }
        }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 sm:p-4 lg:p-6 font-sans antialiased text-brand-text">

    <!-- 氛围背景 -->
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="bg-shape shape-3"></div>

    <!-- 主容器 -->
    <div class="app-shell glass-panel rounded-[2rem] flex flex-col md:flex-row overflow-hidden relative">
        <!-- 手机端侧边栏抽屉 -->
        <aside id="mobile-drawer" class="absolute left-0 top-0 h-full z-50 bg-white/95 backdrop-blur-xl shadow-xl transition-transform duration-300 w-[72px] -translate-x-full">
            <div class="h-full flex flex-col p-3">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="toggleMobileLabels()" class="w-10 h-10 rounded-lg bg-brand-light text-brand-main flex items-center justify-center">
                        <i class="ph ph-sidebar text-xl"></i>
                    </button>
                    <button id="mobile-drawer-close" onclick="toggleMobileDrawer(false)" class="w-8 h-8 rounded-lg text-brand-text/60 items-center justify-center bg-white/80 border border-white">
                        <i class="ph ph-x"></i>
                    </button>
                </div>
                <nav class="flex flex-col gap-2">
                    <button onclick="switchTab('checkin'); toggleMobileDrawer(false)" id="mnav-checkin" class="mobile-nav-btn text-brand-main">
                        <i class="ph ph-check-square-offset text-xl"></i><span class="mobile-label whitespace-nowrap">今日打卡</span>
                    </button>
                    <button onclick="switchTab('stats'); toggleMobileDrawer(false)" id="mnav-stats" class="mobile-nav-btn text-brand-text/70">
                        <i class="ph ph-chart-line-up text-xl"></i><span class="mobile-label whitespace-nowrap">统计总览</span>
                    </button>
                    <button onclick="switchTab('records'); toggleMobileDrawer(false)" id="mnav-records" class="mobile-nav-btn text-brand-text/70">
                        <i class="ph ph-notebook text-xl"></i><span class="mobile-label whitespace-nowrap">记录回顾</span>
                    </button>
                    <button onclick="openShareModal(); toggleMobileDrawer(false)" class="mobile-nav-btn text-brand-text/70">
                        <i class="ph ph-share-network text-xl"></i><span class="mobile-label whitespace-nowrap">分享打卡结果</span>
                    </button>
                    <button onclick="openAuthModal(); toggleMobileDrawer(false)" class="mobile-nav-btn text-brand-text/70">
                        <i class="ph ph-user-circle text-xl"></i><span class="mobile-label whitespace-nowrap">账号登录同步</span>
                    </button>
                </nav>
            </div>
        </aside>
        <div id="mobile-drawer-mask" onclick="toggleMobileDrawer(false)" class="absolute inset-0 z-40 bg-black/25 opacity-0 pointer-events-none transition-opacity duration-300"></div>
        
        <!-- 左侧导航栏 -->
        <aside class="app-sidebar hidden md:flex border-b md:border-b-0 md:border-r border-white/60 flex-col justify-between z-10">
            <div>
                <div class="flex items-center gap-3 mb-12">
                    <div class="w-10 h-10 rounded-xl bg-brand-light flex items-center justify-center text-brand-main shadow-inner">
                        <i class="ph ph-leaf text-2xl"></i>
                    </div>
                    <h1 class="text-2xl font-semibold tracking-wide text-brand-dark">静好 <span class="text-sm font-normal opacity-70">打卡</span></h1>
                </div>

                <nav class="space-y-3">
                    <button onclick="switchTab('checkin')" id="nav-checkin" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all bg-white/70 shadow-sm text-brand-main font-semibold">
                        <i class="ph ph-check-square-offset text-xl"></i>
                        今日打卡
                    </button>
                    <button onclick="switchTab('stats')" id="nav-stats" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-white/50 text-brand-text/70 hover:text-brand-main font-medium">
                        <i class="ph ph-chart-line-up text-xl"></i>
                        统计总览
                    </button>
                    <button onclick="switchTab('records')" id="nav-records" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-white/50 text-brand-text/70 hover:text-brand-main font-medium">
                        <i class="ph ph-notebook text-xl"></i>
                        记录回顾
                    </button>
                </nav>

                <div class="mt-6">
                    <button onclick="openShareModal()" id="share-btn" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl glass-btn">
                        <i class="ph ph-share-network text-lg"></i>
                        共享打卡结果
                    </button>
                </div>
                <div class="mt-3">
                    <button onclick="openAuthModal()" id="auth-btn" class="w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl bg-white/60 border border-white/80 text-brand-main hover:bg-white/80 transition-all">
                        <i class="ph ph-user-circle text-lg"></i>
                        账号登录同步
                    </button>
                </div>
            </div>

            <div class="mt-8 text-sm text-center md:text-left text-brand-text/60">
                <p id="current-date-display" class="font-semibold text-brand-dark"></p>
                <p class="mt-1">保持专注，静待花开。</p>
            </div>
        </aside>

        <!-- 右侧内容区 -->
        <main class="app-main flex-1 overflow-y-auto z-10 relative">
            <div id="mobile-topbar" class="hidden items-center gap-3 mb-3">
                <button id="mobile-menu-toggle" onclick="toggleMobileDrawer(true)" class="w-11 h-11 rounded-xl bg-white/85 border border-white text-brand-main items-center justify-center shadow flex">
                    <i class="ph ph-list text-2xl"></i>
                </button>
                <div id="mobile-topbar-title" class="text-sm font-semibold text-brand-text/70">今日打卡</div>
            </div>
            
            <!-- ====== 打卡视图 ====== -->
            <div id="view-checkin" class="h-full flex flex-col transition-opacity duration-300">
                <header class="mb-6 w-full">
                    <!-- 添加新习惯 -->
                    <form id="add-habit-form" class="flex items-center gap-3 w-full flex-wrap sm:flex-nowrap">
                        <input type="text" id="new-habit-input" placeholder="输入新习惯..." class="glass-input px-5 py-3 flex-1 text-base font-medium" required>
                        <button type="submit" class="glass-btn px-6 py-3 rounded-xl text-base flex items-center gap-1 shrink-0">
                            <i class="ph ph-plus font-bold"></i> 添加
                        </button>
                    </form>
                    <div class="mt-3 flex items-center justify-between gap-3">
                        <p id="checkin-date-tip" class="text-sm text-brand-text/70 font-medium"></p>
                        <button id="go-today-btn" onclick="goToToday()" class="hidden px-3 py-1.5 rounded-lg bg-white/70 border border-white text-brand-main text-sm font-semibold hover:bg-white transition-all">
                            回到今日
                        </button>
                    </div>
                </header>

                <!-- 新增：周日历视图 -->
                <div class="mb-6 bg-white/40 p-3 sm:p-4 rounded-2xl border border-white/60 backdrop-blur-md flex items-center justify-between gap-1 overflow-x-auto overflow-y-visible min-h-[84px]" id="weekly-calendar">
                    <!-- 动态生成的周日历将渲染在这里 -->
                </div>

                <div class="flex-1">
                    <div id="habits-list" class="flex flex-col gap-3">
                        <!-- 动态生成的打卡项目将渲染在这里 -->
                    </div>
                    <div id="empty-state" class="hidden flex flex-col items-center justify-center h-64 opacity-60">
                        <i class="ph ph-wind text-6xl mb-4 text-brand-main"></i>
                        <p class="font-medium">还没有添加任何习惯，从上方开始吧。</p>
                    </div>
                </div>
            </div>

            <!-- ====== 统计视图 ====== -->
            <div id="view-stats" class="hidden-tab h-full flex flex-col transition-opacity duration-300">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-brand-dark mb-1">数据沉淀，见证成长</h2>
                    <p class="text-brand-text/70">每一次打卡，都是向更好的自己迈进的一步。</p>
                </header>

                <!-- 时间维度切换 -->
                <div class="flex gap-2 mb-8 bg-white/40 p-1.5 rounded-2xl w-fit backdrop-blur-md border border-white/60">
                    <button onclick="setStatPeriod('day')" class="stat-tab active px-5 py-1.5 rounded-xl text-sm font-semibold transition-all text-brand-main shadow-sm bg-white border border-white/80">日</button>
                    <button onclick="setStatPeriod('week')" class="stat-tab px-5 py-1.5 rounded-xl text-sm font-medium transition-all text-brand-text/70 hover:text-brand-main">周</button>
                    <button onclick="setStatPeriod('month')" class="stat-tab px-5 py-1.5 rounded-xl text-sm font-medium transition-all text-brand-text/70 hover:text-brand-main">月</button>
                    <button onclick="setStatPeriod('quarter')" class="stat-tab px-5 py-1.5 rounded-xl text-sm font-medium transition-all text-brand-text/70 hover:text-brand-main">季</button>
                    <button onclick="setStatPeriod('year')" class="stat-tab px-5 py-1.5 rounded-xl text-sm font-medium transition-all text-brand-text/70 hover:text-brand-main">年</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="glass-card p-5 text-center">
                        <p class="text-brand-text/70 text-sm font-medium mb-1">期间打卡总数</p>
                        <p id="stat-total-checkins" class="text-4xl font-bold text-brand-main">0</p>
                    </div>
                    <div class="glass-card p-5 text-center">
                        <p class="text-brand-text/70 text-sm font-medium mb-1">最高连续坚持(天)</p>
                        <p id="stat-max-streak" class="text-4xl font-bold text-brand-main">0</p>
                    </div>
                    <div class="glass-card p-5 text-center">
                        <p class="text-brand-text/70 text-sm font-medium mb-1">完成率</p>
                        <p id="stat-completion-rate" class="text-4xl font-bold text-brand-main">0%</p>
                    </div>
                </div>

                <!-- 按项目分类的单行数据统计列表 -->
                <div id="habit-stats-list" class="flex flex-col gap-4 mb-8">
                    <!-- 动态生成的项目统计行将渲染在这里 -->
                </div>

                <div class="flex-1 glass-card p-6 min-h-[300px] flex items-center justify-center">
                    <canvas id="statsChart"></canvas>
                </div>
            </div>

            <!-- ====== 记录回顾视图 ====== -->
            <div id="view-records" class="hidden-tab h-full flex flex-col transition-opacity duration-300">
                <header class="mb-8">
                    <h2 class="text-3xl font-bold text-brand-dark mb-1">时光印记，点滴感悟</h2>
                    <p class="text-brand-text/70">回看走过的路，写下的文字是最好的见证。</p>
                </header>
                
                <div class="flex-1 overflow-y-auto pr-2">
                    <div id="records-list" class="flex flex-col gap-6">
                        <!-- 动态生成的文字记录将渲染在这里 -->
                    </div>
                    <div id="records-empty-state" class="hidden flex flex-col items-center justify-center h-64 opacity-60">
                        <i class="ph ph-wind text-6xl mb-4 text-brand-main"></i>
                        <p class="font-medium">还没有留下任何文字记录，今天写点什么吧。</p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- 页面内确认弹窗 -->
    <div id="confirm-modal" class="modal-mask" aria-hidden="true">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6">
            <h3 class="text-xl font-bold text-brand-dark mb-2">确认操作</h3>
            <p id="confirm-message" class="text-sm text-brand-text/80 mb-6">确定继续吗？</p>
            <div class="flex items-center justify-end gap-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 rounded-xl bg-white/70 border border-white text-brand-text/70 hover:bg-white">取消</button>
                <button id="confirm-ok-btn" class="px-4 py-2 rounded-xl bg-red-500 text-white font-semibold hover:bg-red-600">确认删除</button>
            </div>
        </div>
    </div>

    <!-- 编辑习惯名称弹窗 -->
    <div id="edit-habit-modal" class="modal-mask" aria-hidden="true">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6">
            <h3 class="text-xl font-bold text-brand-dark mb-2">编辑打卡名称</h3>
            <p class="text-sm text-brand-text/70 mb-4">修改后会同步影响今日打卡、统计总览和记录回顾。</p>
            <input id="edit-habit-input" class="glass-input w-full px-3 py-2 text-sm" maxlength="40" placeholder="请输入新名称">
            <p id="edit-habit-status" class="text-xs mt-3 text-red-500 hidden">名称不能为空</p>
            <div class="flex items-center justify-end gap-3 mt-5">
                <button id="edit-habit-cancel-btn" class="px-4 py-2 rounded-xl bg-white/70 border border-white text-brand-text/70 hover:bg-white">取消</button>
                <button id="edit-habit-save-btn" class="px-4 py-2 rounded-xl bg-brand-main text-white font-semibold hover:bg-brand-dark">保存</button>
            </div>
        </div>
    </div>

    <!-- 来源统一提示 -->
    <div id="origin-modal" class="modal-mask" aria-hidden="true">
        <div class="glass-panel w-full max-w-lg rounded-2xl p-6">
            <h3 class="text-xl font-bold text-brand-dark mb-2">请统一从本地服务打开</h3>
            <p class="text-sm text-brand-text/80 mb-4">你现在是通过本地文件 `file://` 打开的，这会和 `http://127.0.0.1:5500` 形成两套独立数据与登录状态。</p>
            <p class="text-sm text-brand-text/70 mb-5">请改用：<code>http://127.0.0.1:5500/静好打卡工具.html</code></p>
            <div class="flex gap-2">
                <button id="origin-open-localhost-btn" class="px-4 py-2 rounded-xl bg-brand-main text-white font-semibold hover:bg-brand-dark">打开 localhost</button>
                <button id="origin-close-btn" class="px-4 py-2 rounded-xl bg-white/70 border border-white text-brand-text/70 hover:bg-white">我知道了</button>
            </div>
        </div>
    </div>

    <!-- 共享弹窗 -->
    <div id="share-modal" class="modal-mask" aria-hidden="true">
        <div class="glass-panel w-full max-w-lg rounded-2xl p-6">
            <h3 class="text-xl font-bold text-brand-dark mb-2">共享打卡结果</h3>
            <p class="text-sm text-brand-text/70 mb-4">生成只读链接，发给他人即可查看当前快照。</p>
            <div class="flex gap-2 mb-3">
                <button id="generate-share-btn" class="px-4 py-2 rounded-xl bg-brand-main text-white font-semibold hover:bg-brand-dark">生成共享链接</button>
                <button id="close-share-btn" class="px-4 py-2 rounded-xl bg-white/70 border border-white text-brand-text/70 hover:bg-white">关闭</button>
            </div>
            <textarea id="share-link-output" readonly class="glass-input w-full p-3 text-sm min-h-[92px] text-slate-700" placeholder="点击“生成共享链接”"></textarea>
            <p id="share-hint" class="text-xs text-brand-text/60 mt-2"></p>
        </div>
    </div>

    <!-- 账号登录弹窗 -->
    <div id="auth-modal" class="modal-mask" aria-hidden="true">
        <div class="glass-panel w-full max-w-xl rounded-2xl p-6">
            <h3 class="text-xl font-bold text-brand-dark mb-2">账号登录（跨设备同步）</h3>
            <p class="text-xs text-brand-text/70 mb-4">使用邮箱+密码登录；同设备默认半年内无需重复登录。</p>
            <div id="auth-login-block" class="space-y-3">
                <input id="auth-email-input" class="glass-input w-full px-3 py-2 text-sm" placeholder="邮箱，例如 name@example.com">
                <input id="auth-password-input" type="password" class="glass-input w-full px-3 py-2 text-sm" placeholder="密码（至少6位）">
            </div>
            <div id="auth-user-block" class="hidden text-sm text-brand-text/80 mb-3"></div>
            <div class="flex flex-wrap gap-2 mt-4">
                <button id="auth-signin-btn" class="px-4 py-2 rounded-xl bg-brand-main text-white font-semibold hover:bg-brand-dark">登录</button>
                <button id="auth-signup-btn" class="px-4 py-2 rounded-xl bg-white/70 border border-white text-brand-text/80 hover:bg-white">注册</button>
                <button id="auth-sync-btn" class="hidden px-4 py-2 rounded-xl bg-white/70 border border-white text-brand-text/80 hover:bg-white">立即同步</button>
                <button id="auth-logout-btn" class="hidden px-4 py-2 rounded-xl bg-white/70 border border-white text-brand-text/80 hover:bg-white">退出登录</button>
                <button id="auth-close-btn" class="px-4 py-2 rounded-xl bg-white/70 border border-white text-brand-text/70 hover:bg-white">关闭</button>
            </div>
            <p id="auth-status" class="text-xs text-brand-text/70 mt-3"></p>
        </div>
    </div>

    <script>
        // ======= 数据模型与状态 (In-Memory) =======
        const todayStr = new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
        const STORAGE_KEY = 'jinghao-checkin-state-v1';
        const SUPABASE_URL = 'https://isnoaavqpurryevhegnd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlzbm9hYXZxcHVycnlldmhlZ25kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxOTI2OTIsImV4cCI6MjA4Nzc2ODY5Mn0.833Y4EDz-Er0xrEL9PrkowoO88Y8-StGfSPEyrzW_es';
        const LAST_AUTH_AT_KEY = 'jinghao-last-auth-at';
        const AUTH_MAX_AGE_MS = 180 * 24 * 60 * 60 * 1000; // 约半年
        
        let state = {
            habits: [],
            records: {}, 
            currentTab: 'checkin',
            statPeriod: 'day', 
            selectedDateStr: todayStr,
            calendarWeekOffset: 0,
            isShareMode: false,
        };

        let chartInstance = null;
        let confirmCallback = null;
        let supabaseClient = null;
        let authUser = null;
        let cloudSyncTimer = null;
        let mobileLabelsExpanded = false;
        let editingHabitId = null;

        // ======= 初始化与模拟数据 =======
        function initApp() {
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('zh-CN', dateOptions);
            initOriginGuard();

            const sharedPayload = getSharedPayloadFromURL();
            if (sharedPayload) {
                state.habits = Array.isArray(sharedPayload.habits) ? sharedPayload.habits : [];
                state.records = sharedPayload.records && typeof sharedPayload.records === 'object' ? sharedPayload.records : {};
                state.isShareMode = true;
                document.getElementById('share-btn')?.classList.add('hidden');
                document.getElementById('auth-btn')?.classList.add('hidden');
                document.getElementById('add-habit-form')?.classList.add('hidden');
            } else {
                loadStateFromStorage();
                if (!state.records[todayStr]) {
                    state.records[todayStr] = {};
                }
            }

            renderWeeklyCalendar(); // 渲染顶部的周日历
            renderHabits();
            initConfirmModal();
            initEditHabitModal();
            initShareModal();
            initAuthModal();
            initSupabaseAuth();
            if (window.innerWidth <= 768) {
                document.getElementById('mobile-drawer')?.classList.add('-translate-x-full');
                switchTab('checkin');
            }
            
            document.getElementById('add-habit-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addHabit();
            });
        }

        function initOriginGuard() {
            if (window.location.protocol !== 'file:') return;
            const modal = document.getElementById('origin-modal');
            const openBtn = document.getElementById('origin-open-localhost-btn');
            const closeBtn = document.getElementById('origin-close-btn');
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
            openBtn?.addEventListener('click', () => {
                const target = 'http://127.0.0.1:5500/静好打卡工具.html';
                window.location.href = target;
            });
            closeBtn?.addEventListener('click', () => {
                modal.classList.remove('show');
                modal.setAttribute('aria-hidden', 'true');
            });
        }

        // 新增：渲染周日历逻辑
        function renderWeeklyCalendar() {
            const calendarEl = document.getElementById('weekly-calendar');
            if (!calendarEl) return;
            
            calendarEl.innerHTML = '';
            
            const today = new Date();
            const currentDayOfWeek = today.getDay(); // 0 是周日, 1-6 是周一到周六
            const diffToMonday = currentDayOfWeek === 0 ? 6 : currentDayOfWeek - 1; // 调整计算，使周一为本周起点
            
            const monday = new Date(today);
            monday.setDate(today.getDate() - diffToMonday);
            monday.setDate(monday.getDate() + state.calendarWeekOffset * 7);
            
            const weekDays = ['一', '二', '三', '四', '五', '六', '日'];

            const prevBtn = document.createElement('button');
            prevBtn.className = 'w-8 h-8 shrink-0 rounded-full bg-white/60 border border-white/70 text-brand-main hover:bg-white transition-all';
            prevBtn.innerHTML = '<i class="ph ph-caret-left text-base"></i>';
            prevBtn.title = '上一周';
            prevBtn.onclick = () => {
                state.calendarWeekOffset -= 1;
                renderWeeklyCalendar();
            };
            calendarEl.appendChild(prevBtn);
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(monday);
                date.setDate(monday.getDate() + i);
                
                const dateStr = formatDateKey(date);
                const dayNum = date.getDate();
                const isToday = dateStr === todayStr;
                const isSelected = dateStr === state.selectedDateStr;
                
                const dayDiv = document.createElement('div');
                dayDiv.className = `flex flex-col items-center justify-center flex-1 min-w-[58px] py-1.5 cursor-pointer rounded-xl transition-all ${isSelected ? 'bg-brand-light/50' : 'hover:bg-white/40'}`;
                dayDiv.onclick = () => setSelectedDate(dateStr);
                
                // 圆形高亮逻辑：如果今天，使用主题色圆底和白字；否则为毛玻璃白底圆
                dayDiv.innerHTML = `
                    <span class="text-[11px] leading-none font-semibold mb-1 ${(isToday || isSelected) ? 'text-brand-main' : 'text-brand-text/50'}">周${weekDays[i]}</span>
                    <div class="w-9 h-9 flex items-center justify-center rounded-full leading-none font-bold text-base transition-all ${isSelected ? 'bg-brand-main text-white shadow-lg shadow-brand-main/40' : (isToday ? 'bg-brand-light text-brand-main border border-brand-main/20' : 'text-brand-dark bg-white/40 border border-white/60 hover:bg-white/80')}">
                        ${dayNum}
                    </div>
                `;
                calendarEl.appendChild(dayDiv);
            }

            const nextBtn = document.createElement('button');
            const canGoNextWeek = state.calendarWeekOffset < 0;
            nextBtn.className = `w-8 h-8 shrink-0 rounded-full border transition-all ${canGoNextWeek ? 'bg-white/60 border-white/70 text-brand-main hover:bg-white' : 'bg-white/30 border-white/40 text-brand-text/30 cursor-not-allowed'}`;
            nextBtn.innerHTML = '<i class="ph ph-caret-right text-base"></i>';
            nextBtn.title = '下一周';
            nextBtn.onclick = () => {
                if (!canGoNextWeek) return;
                state.calendarWeekOffset += 1;
                renderWeeklyCalendar();
            };
            calendarEl.appendChild(nextBtn);
        }

        function setSelectedDate(dateStr) {
            state.selectedDateStr = dateStr;
            if (!state.records[dateStr]) {
                state.records[dateStr] = {};
            }
            renderWeeklyCalendar();
            if (state.currentTab === 'checkin') {
                renderHabits();
            }
        }

        function goToToday() {
            state.selectedDateStr = todayStr;
            state.calendarWeekOffset = 0;
            if (!state.records[todayStr]) {
                state.records[todayStr] = {};
            }
            renderWeeklyCalendar();
            if (state.currentTab === 'checkin') {
                renderHabits();
            }
        }

        function getHabitStats(habitId) {
            let total = 0;
            for (let dateStr in state.records) {
                if (state.records[dateStr][habitId] && state.records[dateStr][habitId].completed) {
                    total++;
                }
            }
            return { total };
        }

        // ======= 核心逻辑：打卡视图 =======
        function renderHabits() {
            const listEl = document.getElementById('habits-list');
            const emptyEl = document.getElementById('empty-state');
            const dateTipEl = document.getElementById('checkin-date-tip');
            const goTodayBtn = document.getElementById('go-today-btn');
            
            listEl.innerHTML = '';
            if (dateTipEl) {
                dateTipEl.textContent = state.isShareMode
                    ? `共享快照查看：${state.selectedDateStr}`
                    : `当前查看：${state.selectedDateStr}${state.selectedDateStr === todayStr ? '（今天）' : ''}`;
            }
            if (goTodayBtn) {
                if (state.selectedDateStr === todayStr) goTodayBtn.classList.add('hidden');
                else goTodayBtn.classList.remove('hidden');
            }

            if (state.habits.length === 0) {
                listEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                emptyEl.classList.add('flex');
                return;
            }

            listEl.classList.remove('hidden');
            emptyEl.classList.add('hidden');

            state.habits.forEach(habit => {
                const record = state.records[state.selectedDateStr]?.[habit.id] || { completed: false, note: '' };
                const isChecked = record.completed;
                const stats = getHabitStats(habit.id); 

                const card = document.createElement('div');
                card.className = `glass-card p-4 flex flex-col gap-2 transition-all ${isChecked ? 'bg-white/70 shadow-sm' : 'border-white/90 shadow-md'}`;
                
                // 动态按钮样式 - 增强色彩感
                const btnClass = isChecked 
                    ? "habit-action px-4 py-1.5 rounded-xl bg-white border-2 border-brand-main/20 text-brand-main font-bold shadow-sm transition-all flex items-center gap-1.5" 
                    : "habit-action px-4 py-1.5 rounded-xl bg-brand-main text-white font-bold hover:bg-brand-dark shadow-lg shadow-brand-main/30 hover:shadow-xl hover:shadow-brand-main/40 transition-all flex items-center gap-1.5 hover:-translate-y-0.5";
                
                const btnText = isChecked ? '<i class="ph ph-check-circle text-lg font-bold"></i> 已打卡' : '<i class="ph ph-fingerprint text-lg"></i> 立即打卡';
                const toggleAction = `toggleCheckin('${habit.id}', ${!isChecked})`;

                card.innerHTML = `
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="habit-title font-bold text-xl text-brand-dark ${isChecked ? 'text-brand-dark/50 line-through' : ''}">${escapeHTML(habit.name)}</span>
                                ${state.isShareMode ? '' : `
                                <button onclick="openEditHabitModal('${habit.id}')" class="text-brand-text/45 hover:text-brand-main transition-colors text-xs font-semibold flex items-center gap-1" title="编辑名称">
                                    <i class="ph ph-pencil-simple"></i> 编辑
                                </button>
                                `}
                            </div>
                            <div class="text-xs font-semibold ${isChecked ? 'text-brand-main' : 'text-brand-text/60'} flex items-center gap-1.5 bg-brand-light/40 w-fit px-2 py-0.5 rounded-lg border border-brand-light/50">
                                <i class="ph ph-medal text-sm"></i> 累计打卡 ${stats.total} 天
                            </div>
                        </div>
                        ${state.isShareMode ? '' : `
                        <div class="flex flex-col items-end gap-1.5 shrink-0">
                            <button onclick="${toggleAction}" class="${btnClass}">
                                ${btnText}
                            </button>
                            <button onclick="deleteHabit('${habit.id}')" class="text-brand-text/40 hover:text-red-500 transition-colors text-xs flex items-center gap-1 mt-0.5 font-medium" title="删除项目">
                                <i class="ph ph-trash"></i> 删除
                            </button>
                        </div>
                        `}
                    </div>
                    <div>
                        <textarea 
                            class="habit-note glass-input w-full p-2.5 text-xs font-medium resize-none rounded-xl min-h-[40px] text-slate-600 overflow-hidden"
                            placeholder="${state.isShareMode ? '共享视图不可编辑' : '写点什么简短的记录吧...'}"
                            ${state.isShareMode ? 'readonly' : `oninput="handleNoteInput('${habit.id}', this)" onblur="saveNote('${habit.id}', this.value)"`}
                        >${escapeHTML(record.note)}</textarea>
                    </div>
                `;
                listEl.appendChild(card);
                const textarea = card.querySelector('textarea');
                if (textarea) autoResizeTextarea(textarea);
            });
        }
        
        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = `${Math.max(el.scrollHeight, 40)}px`;
        }

        function handleNoteInput(habitId, el) {
            if (state.isShareMode) return;
            autoResizeTextarea(el);
            const dateStr = state.selectedDateStr;
            if (!state.records[dateStr]) state.records[dateStr] = {};
            if (!state.records[dateStr][habitId]) state.records[dateStr][habitId] = { completed: false };
            state.records[dateStr][habitId].note = el.value;
            saveStateToStorage();
        }

        function addHabit() {
            if (state.isShareMode) return;
            const input = document.getElementById('new-habit-input');
            const name = input.value.trim();
            if (!name) return;

            const newHabit = {
                id: 'h_' + Date.now(),
                name: name,
                createdAt: todayStr
            };
            
            state.habits.unshift(newHabit);
            input.value = '';
            saveStateToStorage();
            renderHabits();
        }

        function deleteHabit(id) {
            if (state.isShareMode) return;
            openConfirmModal('确定要删除这个打卡项目吗？所有相关记录将不再显示。', () => {
                state.habits = state.habits.filter(h => h.id !== id);
                saveStateToStorage();
                renderHabits();
            });
        }

        function toggleCheckin(habitId, isCompleted) {
            if (state.isShareMode) return;
            const dateStr = state.selectedDateStr;
            if (!state.records[dateStr]) state.records[dateStr] = {};
            if (!state.records[dateStr][habitId]) state.records[dateStr][habitId] = { note: '' };
            
            state.records[dateStr][habitId].completed = isCompleted;
            saveStateToStorage();
            renderHabits();
        }

        function saveNote(habitId, note) {
            if (state.isShareMode) return;
            const dateStr = state.selectedDateStr;
            if (!state.records[dateStr]) state.records[dateStr] = {};
            if (!state.records[dateStr][habitId]) state.records[dateStr][habitId] = { completed: false };
            state.records[dateStr][habitId].note = note.trim();
            saveStateToStorage();
        }

        // ======= 核心逻辑：记录回顾视图 =======
        function renderRecords() {
            const listEl = document.getElementById('records-list');
            const emptyEl = document.getElementById('records-empty-state');
            listEl.innerHTML = '';
            
            let hasAnyNotes = false;
            const sortedDates = Object.keys(state.records).sort((a, b) => b.localeCompare(a));

            sortedDates.forEach(dateStr => {
                const dayRecords = state.records[dateStr];
                const notesForDay = [];
                
                state.habits.forEach(habit => {
                    const r = dayRecords[habit.id];
                    if (r && r.note && r.note.trim() !== '') {
                        notesForDay.push({
                            habitId: habit.id,
                            habitName: habit.name,
                            note: r.note.trim(),
                            completed: r.completed
                        });
                    }
                });

                if (notesForDay.length > 0) {
                    hasAnyNotes = true;
                    
                    const card = document.createElement('div');
                    card.className = 'glass-card p-6 flex flex-col gap-4 border-t-4 border-t-brand-main'; // 顶部加粗边框增加设计感
                    
                    let notesHTML = `
                        <div class="border-b border-brand-light/80 pb-3 mb-1">
                            <h3 class="text-lg font-bold text-brand-dark flex items-center gap-2">
                                <i class="ph ph-calendar-blank text-xl text-brand-main"></i> ${dateStr}
                            </h3>
                        </div>
                    `;
                    
                    notesForDay.forEach(n => {
                        notesHTML += `
                            <div class="mb-2 bg-white/60 p-4 rounded-xl hover:bg-white/90 transition-all shadow-sm">
                                <div class="flex items-center justify-between gap-3 mb-2">
                                    <div class="flex items-center gap-2 text-sm font-bold ${n.completed ? 'text-brand-main' : 'text-brand-text/60'}">
                                        ${n.completed ? '<i class="ph ph-check-circle text-brand-main text-lg"></i>' : '<i class="ph ph-circle text-lg"></i>'}
                                        ${escapeHTML(n.habitName)}
                                    </div>
                                    ${state.isShareMode ? '' : `<button data-action="delete-record" data-date="${dateStr}" data-habit="${n.habitId}" class="text-brand-text/40 hover:text-red-500 transition-colors text-sm flex items-center gap-1 font-medium" title="删除记录">
                                        <i class="ph ph-trash"></i> 删除
                                    </button>`}
                                </div>
                                <p class="text-brand-text text-sm leading-relaxed whitespace-pre-wrap pl-6 border-l-2 border-brand-main/40 ml-2 font-medium">${escapeHTML(n.note)}</p>
                            </div>
                        `;
                    });
                    
                    card.innerHTML = notesHTML;
                    listEl.appendChild(card);
                }
            });

            listEl.querySelectorAll('button[data-action="delete-record"]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const dateStr = btn.dataset.date;
                    const habitId = btn.dataset.habit;
                    deleteRecordNote(dateStr, habitId);
                });
            });

            if (!hasAnyNotes) {
                listEl.classList.add('hidden');
                emptyEl.classList.remove('hidden');
                emptyEl.classList.add('flex');
            } else {
                listEl.classList.remove('hidden');
                emptyEl.classList.add('hidden');
                emptyEl.classList.remove('flex');
            }
        }

        function deleteRecordNote(dateStr, habitId) {
            if (state.isShareMode) return;
            openConfirmModal('确认删除这条记录吗？', () => {
                const dayRecords = state.records[dateStr];
                if (!dayRecords || !dayRecords[habitId]) return;

                dayRecords[habitId].note = '';
                if (!dayRecords[habitId].completed) {
                    delete dayRecords[habitId];
                }
                if (Object.keys(dayRecords).length === 0) {
                    delete state.records[dateStr];
                }

                saveStateToStorage();
                renderRecords();
                if (state.selectedDateStr === dateStr) {
                    renderHabits();
                }
            });
        }

        function initConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            const cancelBtn = document.getElementById('confirm-cancel-btn');
            const okBtn = document.getElementById('confirm-ok-btn');

            cancelBtn.addEventListener('click', closeConfirmModal);
            okBtn.addEventListener('click', () => {
                const cb = confirmCallback;
                closeConfirmModal();
                if (typeof cb === 'function') cb();
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeConfirmModal();
            });
        }

        function openConfirmModal(message, onConfirm) {
            const modal = document.getElementById('confirm-modal');
            const messageEl = document.getElementById('confirm-message');
            messageEl.textContent = message;
            confirmCallback = onConfirm;
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
            confirmCallback = null;
        }

        function initEditHabitModal() {
            const modal = document.getElementById('edit-habit-modal');
            document.getElementById('edit-habit-cancel-btn')?.addEventListener('click', closeEditHabitModal);
            document.getElementById('edit-habit-save-btn')?.addEventListener('click', saveHabitNameEdit);
            document.getElementById('edit-habit-input')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveHabitNameEdit();
                }
            });
            modal?.addEventListener('click', (e) => {
                if (e.target === modal) closeEditHabitModal();
            });
        }

        function openEditHabitModal(habitId) {
            if (state.isShareMode) return;
            const habit = state.habits.find(h => h.id === habitId);
            if (!habit) return;
            editingHabitId = habitId;
            const modal = document.getElementById('edit-habit-modal');
            const input = document.getElementById('edit-habit-input');
            const status = document.getElementById('edit-habit-status');
            if (status) status.classList.add('hidden');
            if (input) {
                input.value = habit.name || '';
                setTimeout(() => {
                    input.focus();
                    input.select();
                }, 10);
            }
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeEditHabitModal() {
            editingHabitId = null;
            const modal = document.getElementById('edit-habit-modal');
            const status = document.getElementById('edit-habit-status');
            if (status) status.classList.add('hidden');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        function saveHabitNameEdit() {
            if (!editingHabitId) return;
            const input = document.getElementById('edit-habit-input');
            const status = document.getElementById('edit-habit-status');
            const newName = (input?.value || '').trim();
            if (!newName) {
                if (status) {
                    status.textContent = '名称不能为空';
                    status.classList.remove('hidden');
                }
                return;
            }
            state.habits = state.habits.map(h => h.id === editingHabitId ? { ...h, name: newName } : h);
            saveStateToStorage();
            closeEditHabitModal();
            renderHabits();
            if (state.currentTab === 'records') renderRecords();
            if (state.currentTab === 'stats') renderStats();
        }

        function saveStateToStorage() {
            if (state.isShareMode) return;
            const payload = {
                habits: state.habits,
                records: state.records
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
            scheduleCloudPush();
        }

        function loadStateFromStorage() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            try {
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed.habits)) state.habits = parsed.habits;
                if (parsed.records && typeof parsed.records === 'object') state.records = parsed.records;
            } catch (_) {
                // ignore broken cache
            }
        }

        function initShareModal() {
            const shareModal = document.getElementById('share-modal');
            const closeBtn = document.getElementById('close-share-btn');
            const genBtn = document.getElementById('generate-share-btn');
            const output = document.getElementById('share-link-output');
            const hint = document.getElementById('share-hint');

            closeBtn?.addEventListener('click', closeShareModal);
            genBtn?.addEventListener('click', () => {
                const link = createShareLink();
                output.value = link;
                output.select();
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(link).then(() => {
                        hint.textContent = '链接已复制，可直接发送。';
                    }).catch(() => {
                        hint.textContent = '已生成链接，复制后发送。';
                    });
                } else {
                    hint.textContent = '已生成链接，复制后发送。';
                }
            });
            shareModal?.addEventListener('click', (e) => {
                if (e.target === shareModal) closeShareModal();
            });
        }

        function isSupabaseConfigured() {
            return SUPABASE_URL.startsWith('http') && SUPABASE_ANON_KEY && !SUPABASE_URL.includes('YOUR_SUPABASE_URL');
        }

        function setAuthStatus(msg, isError = false) {
            const el = document.getElementById('auth-status');
            if (!el) return;
            el.textContent = msg;
            el.className = `text-xs mt-3 ${isError ? 'text-red-600' : 'text-brand-text/70'}`;
        }

        function updateAuthButtonLabel() {
            const btn = document.getElementById('auth-btn');
            if (!btn) return;
            if (!isSupabaseConfigured()) {
                btn.innerHTML = '<i class="ph ph-warning-circle text-lg"></i> 未配置 Supabase';
                return;
            }
            if (authUser?.email) {
                btn.innerHTML = `<i class="ph ph-user-circle text-lg"></i> ${escapeHTML(authUser.email)}`;
            } else {
                btn.innerHTML = '<i class="ph ph-user-circle text-lg"></i> 账号登录同步';
            }
        }

        function initAuthModal() {
            const modal = document.getElementById('auth-modal');
            document.getElementById('auth-close-btn')?.addEventListener('click', closeAuthModal);
            document.getElementById('auth-signin-btn')?.addEventListener('click', signinWithPassword);
            document.getElementById('auth-signup-btn')?.addEventListener('click', signupWithPassword);
            document.getElementById('auth-sync-btn')?.addEventListener('click', async () => {
                await pullUserDataFromCloud(true);
            });
            document.getElementById('auth-logout-btn')?.addEventListener('click', logoutAuth);
            modal?.addEventListener('click', (e) => {
                if (e.target === modal) closeAuthModal();
            });
        }

        function openAuthModal() {
            const modal = document.getElementById('auth-modal');
            const loginBlock = document.getElementById('auth-login-block');
            const userBlock = document.getElementById('auth-user-block');
            const signinBtn = document.getElementById('auth-signin-btn');
            const signupBtn = document.getElementById('auth-signup-btn');
            const syncBtn = document.getElementById('auth-sync-btn');
            const logoutBtn = document.getElementById('auth-logout-btn');
            if (authUser?.email) {
                loginBlock.classList.add('hidden');
                userBlock.classList.remove('hidden');
                userBlock.textContent = `当前登录：${authUser.email}`;
                signinBtn.classList.add('hidden');
                signupBtn.classList.add('hidden');
                syncBtn.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                loginBlock.classList.remove('hidden');
                userBlock.classList.add('hidden');
                userBlock.textContent = '';
                signinBtn.classList.remove('hidden');
                signupBtn.classList.remove('hidden');
                syncBtn.classList.add('hidden');
                logoutBtn.classList.add('hidden');
            }
            setAuthStatus('');
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeAuthModal() {
            const modal = document.getElementById('auth-modal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        async function initSupabaseAuth() {
            updateAuthButtonLabel();
            if (state.isShareMode || !isSupabaseConfigured()) return;
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            const { data: { session } } = await supabaseClient.auth.getSession();
            authUser = session?.user || null;
            if (authUser && !isAuthFresh()) {
                await supabaseClient.auth.signOut();
                authUser = null;
                setAuthStatus('登录已超过半年，请重新登录。');
            } else if (authUser) {
                touchAuthTimestamp();
            }
            updateAuthButtonLabel();
            if (authUser) {
                await pullUserDataFromCloud(false);
            }
            supabaseClient.auth.onAuthStateChange(async (_event, session) => {
                authUser = session?.user || null;
                if (authUser) {
                    touchAuthTimestamp();
                } else {
                    clearAuthTimestamp();
                }
                updateAuthButtonLabel();
                if (authUser) {
                    await pullUserDataFromCloud(false);
                }
            });
        }

        async function signinWithPassword() {
            if (!supabaseClient) return setAuthStatus('Supabase 未配置。', true);
            const email = (document.getElementById('auth-email-input').value || '').trim();
            const password = (document.getElementById('auth-password-input').value || '').trim();
            if (!email || !password) return setAuthStatus('请输入邮箱和密码。', true);
            const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
            if (error) return setAuthStatus(`登录失败：${error.message}`, true);
            touchAuthTimestamp();
            setAuthStatus('登录成功，正在同步...');
            closeAuthModal();
        }

        async function signupWithPassword() {
            if (!supabaseClient) return setAuthStatus('Supabase 未配置。', true);
            const email = (document.getElementById('auth-email-input').value || '').trim();
            const password = (document.getElementById('auth-password-input').value || '').trim();
            if (!email || !password) return setAuthStatus('请输入邮箱和密码。', true);
            if (password.length < 6) return setAuthStatus('密码至少 6 位。', true);
            const { error } = await supabaseClient.auth.signUp({ email, password });
            if (error) return setAuthStatus(`注册失败：${error.message}`, true);
            setAuthStatus('注册成功，请直接点击“登录”。');
        }

        async function logoutAuth() {
            if (!supabaseClient) return;
            await supabaseClient.auth.signOut();
            authUser = null;
            clearAuthTimestamp();
            updateAuthButtonLabel();
            setAuthStatus('已退出登录。');
            closeAuthModal();
        }

        function touchAuthTimestamp() {
            localStorage.setItem(LAST_AUTH_AT_KEY, String(Date.now()));
        }

        function clearAuthTimestamp() {
            localStorage.removeItem(LAST_AUTH_AT_KEY);
        }

        function isAuthFresh() {
            const raw = localStorage.getItem(LAST_AUTH_AT_KEY);
            if (!raw) return false;
            const ts = Number(raw);
            if (!Number.isFinite(ts)) return false;
            return (Date.now() - ts) <= AUTH_MAX_AGE_MS;
        }

        async function pullUserDataFromCloud(showStatus = true) {
            if (!supabaseClient || !authUser?.id) return;
            if (showStatus) setAuthStatus('云端拉取中...');
            const { data, error } = await supabaseClient
                .from('user_checkin_docs')
                .select('data')
                .eq('user_id', authUser.id)
                .maybeSingle();
            if (error) {
                if (showStatus) setAuthStatus(`拉取失败：${error.message}`, true);
                return;
            }
            if (data?.data) {
                state.habits = Array.isArray(data.data.habits) ? data.data.habits : [];
                state.records = data.data.records && typeof data.data.records === 'object' ? data.data.records : {};
                if (!state.records[todayStr]) state.records[todayStr] = {};
                localStorage.setItem(STORAGE_KEY, JSON.stringify({ habits: state.habits, records: state.records }));
                renderHabits();
                if (state.currentTab === 'records') renderRecords();
                if (state.currentTab === 'stats') renderStats();
                if (showStatus) setAuthStatus('已同步云端数据。');
            } else if (showStatus) {
                if (hasLocalData()) {
                    await pushUserDataToCloud('manual');
                    setAuthStatus('云端为空，已自动上传当前本地数据。');
                } else {
                    setAuthStatus('云端暂无数据，可先在本设备录入后自动上传。');
                }
            }
        }

        async function pushUserDataToCloud(source = 'auto') {
            if (state.isShareMode || !supabaseClient || !authUser?.id) return;
            const payload = { habits: state.habits, records: state.records };
            const { error } = await supabaseClient
                .from('user_checkin_docs')
                .upsert({ user_id: authUser.id, data: payload }, { onConflict: 'user_id' });
            if (source === 'manual') {
                if (error) setAuthStatus(`上传失败：${error.message}`, true);
                else setAuthStatus('上传成功。');
            }
        }

        function scheduleCloudPush() {
            if (!supabaseClient || !authUser?.id || state.isShareMode) return;
            if (cloudSyncTimer) clearTimeout(cloudSyncTimer);
            cloudSyncTimer = setTimeout(() => {
                pushUserDataToCloud('auto');
            }, 500);
        }

        function hasLocalData() {
            return (Array.isArray(state.habits) && state.habits.length > 0) || (state.records && Object.keys(state.records).length > 1);
        }

        function openShareModal() {
            const modal = document.getElementById('share-modal');
            const output = document.getElementById('share-link-output');
            const hint = document.getElementById('share-hint');
            if (output) output.value = '';
            if (hint) hint.textContent = '';
            modal.classList.add('show');
            modal.setAttribute('aria-hidden', 'false');
        }

        function closeShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.remove('show');
            modal.setAttribute('aria-hidden', 'true');
        }

        function createShareLink() {
            const snapshot = {
                habits: state.habits,
                records: state.records,
                generatedAt: new Date().toISOString()
            };
            const encoded = encodeURIComponent(btoa(unescape(encodeURIComponent(JSON.stringify(snapshot)))));
            const url = new URL(window.location.href);
            url.searchParams.set('share', encoded);
            return url.toString();
        }

        function getSharedPayloadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const raw = params.get('share');
            if (!raw) return null;
            try {
                const json = decodeURIComponent(escape(atob(decodeURIComponent(raw))));
                return JSON.parse(json);
            } catch (_) {
                return null;
            }
        }

        // ======= 页面切换控制 =======
        function switchTab(tab) {
            state.currentTab = tab;
            const mobileTitle = document.getElementById('mobile-topbar-title');
            if (mobileTitle) {
                mobileTitle.textContent = {
                    checkin: '今日打卡',
                    stats: '统计总览',
                    records: '记录回顾'
                }[tab] || '今日打卡';
            }
            
            const tabs = ['checkin', 'stats', 'records'];
            tabs.forEach(t => {
                const navBtn = document.getElementById(`nav-${t}`);
                const mNavBtn = document.getElementById(`mnav-${t}`);
                if (t === tab) {
                    navBtn.className = 'w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all bg-white/80 shadow-sm text-brand-main font-bold border border-white';
                    if (mNavBtn) {
                        mNavBtn.classList.add('mobile-active', 'text-brand-main');
                        mNavBtn.classList.remove('text-brand-text/70');
                    }
                } else {
                    navBtn.className = 'w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all hover:bg-white/50 text-brand-text/70 hover:text-brand-main font-medium';
                    if (mNavBtn) {
                        mNavBtn.classList.remove('mobile-active', 'text-brand-main');
                        mNavBtn.classList.add('text-brand-text/70');
                    }
                }
                
                const viewEl = document.getElementById(`view-${t}`);
                if (t === tab) {
                    viewEl.classList.remove('hidden-tab');
                } else {
                    viewEl.classList.add('hidden-tab');
                }
            });

            if (tab === 'checkin') {
                renderWeeklyCalendar();
                renderHabits();
            }
            else if (tab === 'stats') renderStats();
            else if (tab === 'records') renderRecords();
        }

        function toggleMobileDrawer(force) {
            const drawer = document.getElementById('mobile-drawer');
            const mask = document.getElementById('mobile-drawer-mask');
            const shouldOpen = typeof force === 'boolean' ? force : drawer.classList.contains('-translate-x-full');
            if (shouldOpen) {
                drawer.classList.remove('-translate-x-full');
                mask.classList.remove('opacity-0', 'pointer-events-none');
                if (!mobileLabelsExpanded) {
                    mobileLabelsExpanded = true;
                    drawer.classList.add('nav-expanded');
                    drawer.classList.remove('w-[72px]');
                    drawer.classList.add('w-[232px]');
                }
            } else {
                drawer.classList.add('-translate-x-full');
                mask.classList.add('opacity-0', 'pointer-events-none');
                if (mobileLabelsExpanded) {
                    mobileLabelsExpanded = false;
                    drawer.classList.remove('nav-expanded');
                    drawer.classList.remove('w-[232px]');
                    drawer.classList.add('w-[72px]');
                }
            }
        }

        function toggleMobileLabels() {
            mobileLabelsExpanded = !mobileLabelsExpanded;
            const drawer = document.getElementById('mobile-drawer');
            if (mobileLabelsExpanded) {
                drawer.classList.add('nav-expanded');
                drawer.classList.remove('w-[72px]');
                drawer.classList.add('w-[232px]');
            } else {
                drawer.classList.remove('nav-expanded');
                drawer.classList.remove('w-[232px]');
                drawer.classList.add('w-[72px]');
            }
        }

        function setStatPeriod(period) {
            state.statPeriod = period;
            
            const tabs = document.querySelectorAll('.stat-tab');
            tabs.forEach(t => {
                t.className = 'stat-tab px-5 py-1.5 rounded-xl text-sm font-medium transition-all text-brand-text/70 hover:text-brand-main';
            });
            const activeTab = Array.from(tabs).find(t => t.innerText === {'day':'日','week':'周','month':'月','quarter':'季','year':'年'}[period]);
            if(activeTab) {
                activeTab.className = 'stat-tab active px-5 py-1.5 rounded-xl text-sm font-bold transition-all text-brand-main shadow-sm bg-white border border-white/80';
            }
            
            renderStats();
        }

        function renderStats() {
            if(state.habits.length === 0) {
                document.getElementById('stat-total-checkins').textContent = '0';
                document.getElementById('stat-max-streak').textContent = '0';
                document.getElementById('stat-completion-rate').textContent = '0%';
                document.getElementById('habit-stats-list').innerHTML = '';
                if(chartInstance) chartInstance.destroy();
                return;
            }

            const dates = getDatesForPeriod(state.statPeriod);
            const datasets = [];
            let totalCheckins = 0;
            let possibleCheckins = dates.length * state.habits.length;

            const listEl = document.getElementById('habit-stats-list');
            listEl.innerHTML = '';

            // 升级的高饱和图表色板
            const colors = ['#4F46E5', '#9333EA', '#06B6D4', '#E11D48', '#F59E0B']; 
            
            state.habits.forEach((habit, index) => {
                let habitCheckins = 0;
                let habitCurrentStreak = 0;
                let habitMaxStreak = 0;

                const dataPoints = dates.map(dateStr => {
                    const completed = state.records[dateStr]?.[habit.id]?.completed ? 1 : 0;
                    totalCheckins += completed;
                    
                    if (completed) {
                        habitCheckins++;
                        habitCurrentStreak++;
                        if (habitCurrentStreak > habitMaxStreak) habitMaxStreak = habitCurrentStreak;
                    } else {
                        habitCurrentStreak = 0;
                    }
                    
                    return completed;
                });

                const rate = dates.length === 0 ? 0 : Math.round((habitCheckins / dates.length) * 100);
                const row = document.createElement('div');
                row.className = 'glass-card p-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 hover:bg-white/80 transition-all shadow-sm';
                row.innerHTML = `
                    <div class="flex items-center gap-4 w-full sm:w-2/5">
                        <div class="w-11 h-11 rounded-xl bg-brand-light flex items-center justify-center text-brand-main shrink-0 shadow-inner border border-white">
                            <i class="ph ph-target text-2xl"></i>
                        </div>
                        <div class="truncate">
                            <h4 class="font-bold text-brand-dark truncate text-lg" title="${escapeHTML(habit.name)}">${escapeHTML(habit.name)}</h4>
                            <p class="text-xs font-semibold text-brand-main mt-0.5">本期最高连打: ${habitMaxStreak} 天</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between w-full sm:w-3/5 gap-4">
                        <div class="text-left sm:text-right w-24 shrink-0">
                            <p class="text-xs font-medium text-brand-text/60 mb-0.5">打卡次数</p>
                            <p class="font-bold text-brand-dark">${habitCheckins} <span class="text-xs font-medium text-brand-text/40">/ ${dates.length}</span></p>
                        </div>
                        <div class="flex-1 max-w-[200px] h-2.5 bg-brand-light/60 rounded-full overflow-hidden border border-brand-light">
                            <div class="h-full bg-brand-main transition-all duration-500 rounded-full shadow-[inset_0_1px_2px_rgba(255,255,255,0.3)]" style="width: ${rate}%"></div>
                        </div>
                        <div class="text-right w-14 shrink-0">
                            <p class="font-bold text-brand-main text-lg">${rate}%</p>
                        </div>
                    </div>
                `;
                listEl.appendChild(row);

                datasets.push({
                    label: habit.name,
                    data: dataPoints,
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length],
                    borderWidth: 2,
                    borderRadius: 4,
                    barPercentage: 0.6
                });
            });

            const aggregatedData = dates.map(dateStr => {
                let dayTotal = 0;
                state.habits.forEach(h => {
                    if(state.records[dateStr]?.[h.id]?.completed) dayTotal++;
                });
                return dayTotal;
            });

            document.getElementById('stat-total-checkins').textContent = totalCheckins;
            const completionRate = possibleCheckins === 0 ? 0 : Math.round((totalCheckins / possibleCheckins) * 100);
            document.getElementById('stat-completion-rate').textContent = completionRate + '%';
            
            let maxStreak = 0;
            let currentStreak = 0;
            const past100Days = getPastDays(100);
            past100Days.forEach(dateStr => {
                let hasCheckin = state.habits.some(h => state.records[dateStr]?.[h.id]?.completed);
                if(hasCheckin) {
                    currentStreak++;
                    if(currentStreak > maxStreak) maxStreak = currentStreak;
                } else {
                    currentStreak = 0;
                }
            });
            document.getElementById('stat-max-streak').textContent = maxStreak;

            const ctx = document.getElementById('statsChart').getContext('2d');
            if (chartInstance) {
                chartInstance.destroy();
            }

            const labels = dates.map(d => {
                const [, m, day] = d.split('-');
                return `${m}/${day}`;
            });

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '总体打卡量',
                        data: aggregatedData,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)', // Indigo-600 with opacity
                        borderColor: '#4F46E5',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }, 
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)', // 深色 Tooltip，更高级
                            titleColor: '#FFFFFF',
                            bodyColor: '#E0E7FF',
                            borderColor: '#312E81',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1, color: '#64748B', font: { weight: '600' } },
                            grid: { color: 'rgba(255,255,255,0.6)', drawBorder: false }
                        },
                        x: {
                            ticks: { color: '#64748B', font: { weight: '600' } },
                            grid: { display: false, drawBorder: false }
                        }
                    }
                }
            });
        }

        // ====== 辅助工具函数 ======
        
        function getDatesForPeriod(period) {
            const today = new Date();
            let days = 7;
            
            if (period === 'day') days = 7; 
            if (period === 'week') days = 14; 
            if (period === 'month') days = 30; 
            if (period === 'quarter') days = 90; 
            if (period === 'year') days = 365;

            return getPastDays(days);
        }

        function getPastDays(numDays) {
            const dates = [];
            const today = new Date();
            for (let i = numDays - 1; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(d.getDate() - i);
                dates.push(formatDateKey(d));
            }
            return dates;
        }

        function formatDateKey(date) {
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
        }

        function escapeHTML(str) {
            return str.replace(/[&<>'"]/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag] || tag)
            );
        }

        window.onload = initApp;

    </script>
</body>
</html>
